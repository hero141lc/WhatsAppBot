<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>用户工作面板</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="#">用户工作面板</a>
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link" href="#">首页</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/logout">注销</a>
      </li>
    </ul>
  </div>
</nav>

<div class="container mt-5">
  <div class="row">
    <% accounts.forEach(account => { %>
      <div class="col-md-4 mb-4">
        <div class="card">
          <% if (accounts.length < 1) { %>
            <p class="text-center">您还没有登录任何 WhatsApp 账号。</p>
            <p class="text-center">
             
            </p>
          <% }%>
          <div class="card-header">
            WhatsApp 账号
            <% if (account.isLoggedIn) { %>
              <span class="badge bg-success float-right"></span>
            <% } %>
          </div>
          <div class="card-body">
            <h5 class="card-title"><%= account.phone %></h5>
            <p class="card-text">备注: <%= account.nickName %></p>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="autoReplySwitch<%= account.id %>">
              <label class="form-check-label" for="autoReplySwitch<%= account.id %>">开关自动回复</label>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="aiReplySwitch<%= account.id %>">
              <label class="form-check-label" for="aiReplySwitch<%= account.id %>">开关 AI 回复</label>
            </div>
            <p class="mt-3">
              <a href="#" class="btn btn-primary btn-sm mr-2" data-bs-toggle="modal" data-bs-target="#editAccountModal" 
              data-accountId="<%= account._id %>" data-phone="<%= account.phone %>" data-nickName="<%= account.nickName %>"
              data-customReply="<%= account.customReply %>" data-autoReply="<%= account.autoReply %>" data-aiReply="<%= account.aiReply %>">
              修改
           </a>
           
               <a href="/delete_account?id=<%= account._id %>" class="btn btn-danger btn-sm">删除</a>

              <% if (account.isLoggedIn) { %>
                <a href="/logout" class="btn btn-danger btn-sm">注销</a>
              <% } else { %>
                <button type="button" class="btn btn-primary btn-sm" id="showQrCodeBtn" data-bs-toggle="modal" data-bs-target="#qrCodeModal">登录</button>
                
<!-- 模态框 -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qrCodeModalLabel">扫描二维码以登录 WhatsApp</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <img id="qrCodeImage" src="" alt="WhatsApp QR Code">
      </div>
    </div>
  </div>
</div>
              <% } %>
            </p>
          </div>
        </div>
      </div>
      
<!-- 修改弹窗 -->
<div class="modal fade" id="editAccountModal" tabindex="-1" aria-labelledby="editAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editAccountModalLabel">修改账号信息</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="editAccountError" class="alert alert-danger" style="display: none;"></div>
        <div>
          <label for="editPhone" class="form-label">电话</label>
          <input type="text" class="form-control" id="editPhone" required>
        </div>
        <div>
          <label for="editNickName" class="form-label">昵称/备注</label>
          <input type="text" class="form-control" id="editNickName" required>
        </div>
        <div>
          <label for="editCustomReply" class="form-label">自定义自动回复</label>
          <input type="text" class="form-control" id="editCustomReply">
        </div>
        <div class="form-check form-switch">
          <input type="checkbox" class="form-check-input" id="editAutoReply">
          <label class="form-check-label" for="editAutoReply">开关自动回复</label>
        </div>
        <div class="form-check form-switch">
          <input type="checkbox" class="form-check-input" id="editAiReply">
          <label class="form-check-label" for="editAiReply">开关 AI 回复</label>
        </div>
        <input type="hidden" id="editAccountId">
        <button id="saveEditAccount" class="btn btn-primary mt-3">保存</button>
      </div>
    </div>
  </div>
</div>


    <% }) %>
  </div>
  <div class="text-end">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">添加新账号</button>
  </div>
</div>
<!-- 添加新账号的弹窗 -->
<div class="modal fade" id="addAccountModal" tabindex="-1" aria-labelledby="addAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addAccountModalLabel">添加新账号</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="errorAlert" class="alert alert-danger" role="alert" style="display: none;"></div>
        <div id="successAlert" class="alert alert-success" role="alert" style="display: none;">新账号已添加</div>
        
        <div class="mb-3">
          <label for="phone" class="form-label">电话</label>
          <input type="text" class="form-control" id="phone" required>
        </div>
        <div class="mb-3">
          <label for="nickName" class="form-label">昵称/备注</label>
          <input type="text" class="form-control" id="nickName" required>
        </div>
        <div class="mb-3">
          <label for="customReply" class="form-label">自定义自动回复</label>
          <input type="text" class="form-control" id="customReply">
        </div>
        <div class="mb-3 form-check">
          <input type="checkbox" class="form-check-input" id="autoReply" checked>
          <label class="form-check-label" for="autoReply">开关自动回复</label>
        </div>
        <div class="mb-3 form-check">
          <input type="checkbox" class="form-check-input" id="aiReply" checked>
          <label class="form-check-label" for="aiReply">开关 AI 回复</label>
        </div>
        <input type="hidden" id="alive" value="false">
        <input type="hidden" id="userId" value="<%= userId %>">
        <button id="saveAccountBtn" class="btn btn-primary">保存</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const showQrCodeBtn = document.getElementById('showQrCodeBtn');
  const qrCodeImage = document.getElementById('qrCodeImage');

  showQrCodeBtn.addEventListener('click', async function () {
    // 发送请求获取登录二维码
    try {
      const response = await fetch('/get_qr_code'); // 后端路由，获取登录二维码的 URL
      const data = await response.json();
      qrCodeImage.src = data.qrCodeUrl; // 设置二维码图片的 URL
    } catch (error) {
      console.error('Error getting QR code', error);
    }
  });
});




//修改，有bug ToDo
 document.addEventListener('DOMContentLoaded', function () {
    const editAccountModal = new bootstrap.Modal(document.getElementById('editAccountModal'));

    const saveEditAccountBtn = document.getElementById('saveEditAccount');
    const editAccountError = document.getElementById('editAccountError');
    var accountId = ''
    document.querySelectorAll('.btn-edit-account').forEach(btn => {
      btn.addEventListener('click', function () {
        accountId = this.getAttribute('data-accountId');
        console.log(this.getAttribute('data-accountId'))
        const phone = this.getAttribute('data-phone');
        const nickName = this.getAttribute('data-nickName');
        const customReply = this.getAttribute('data-customReply');
        const autoReply = this.getAttribute('data-autoReply') === 'true';
        const aiReply = this.getAttribute('data-aiReply') === 'true';

        document.getElementById('editAccountId').value = accountId;
        document.getElementById('editPhone').value = phone;
        document.getElementById('editNickName').value = nickName;
        document.getElementById('editCustomReply').value = customReply;
        document.getElementById('editAutoReply').checked = autoReply;
        document.getElementById('editAiReply').checked = aiReply;

        editAccountModal.show();
      });
    });

    saveEditAccountBtn.addEventListener('click', async function () {
      const accountId = accountId;
      const phone = document.getElementById('editPhone').value;
      const nickName = document.getElementById('editNickName').value;
      const customReply = document.getElementById('editCustomReply').value;
      const autoReply = document.getElementById('editAutoReply').checked;
      const aiReply = document.getElementById('editAiReply').checked;

      const response = await fetch('/edit_whatsapp_account', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          accountId,
          phone,
          nickName,
          customReply,
          autoReply,
          aiReply,
        }),
      });

      if (response.ok) {
        location.reload(); // 重新加载页面以显示更新后的账号列表
      } else {
        const errorData = await response.json();
        editAccountError.textContent = errorData.message;
        editAccountError.style.display = 'block';
      }
    });
  });


  document.addEventListener('DOMContentLoaded', function () {
    const saveAccountBtn = document.getElementById('saveAccountBtn');
    const errorAlert = document.getElementById('errorAlert');
    const successAlert = document.getElementById('successAlert');
    
    saveAccountBtn.addEventListener('click', async function () {
      errorAlert.style.display = 'none';
      successAlert.style.display = 'none';
      
      const phone = document.getElementById('phone').value;
      const nickName = document.getElementById('nickName').value;
      const customReply = document.getElementById('customReply').value;
      const autoReply = document.getElementById('autoReply').checked;
      const aiReply = document.getElementById('aiReply').checked;
      const alive = document.getElementById('alive').value;
      const userId = document.getElementById('userId').value;
      
      const data = {
        phone,
        nickName,
        customReply,
        autoReply,
        aiReply,
        alive,
        userId
      };
      
      try {
        console.log(data)
        const response = await fetch('/add_whatsapp_account', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          successAlert.style.display = 'block';
          setTimeout(() => {
            location.reload(); // 重新加载页面以显示更新后的账号列表
          }, 1000);
        } else {
          errorAlert.style.display = 'block';
        }
      } catch (error) {
        console.error('Error adding new account', error);
        errorAlert.style.display = 'block';
      }
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
